<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geovisor - Informaci√≥n Geogr√°fica Cant√≥n Azogues</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <!-- Bootstrap para mejor dise√±o -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: #f5f7fa;
        }
        
        .header {
            background: linear-gradient(135deg, #1e5799 0%, #207cca 100%);
            color: white;
            padding: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .header h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .controls-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            background: white;
            padding: 1rem;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .layer-controls {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .layer-control-group {
            display: flex;
            align-items: center;
            background: rgba(30, 87, 153, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .layer-toggle-btn {
            padding: 0.5rem 0.8rem;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .layer-toggle-btn i {
            font-size: 16px;
        }
        
        .layer-toggle-btn.active {
            background: #1e5799;
            color: white;
        }
        
        .layer-visibility-btn {
            padding: 0.5rem;
            background: rgba(30, 87, 153, 0.2);
            border: none;
            cursor: pointer;
            color: #1e5799;
            transition: all 0.3s;
        }
        
        .layer-visibility-btn:hover {
            background: rgba(30, 87, 153, 0.3);
        }
        
        .search-container {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .search-box {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
            min-width: 250px;
        }
        
        .search-box input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .search-box button {
            padding: 0.5rem 1rem;
            background: #1e5799;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s;
        }
        
        .search-box button:hover {
            background: #18467e;
        }
        
        .advanced-filters {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 4px;
            margin-top: 0.5rem;
            border: 1px solid #e0e0e0;
            display: none;
        }
        
        .advanced-filters.active {
            display: block;
        }
        
        .filter-group {
            margin-bottom: 0.5rem;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 0.2rem;
            font-size: 14px;
            color: #555;
        }
        
        .filter-group input, .filter-group select {
            width: 100%;
            padding: 0.3rem;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 14px;
        }
        
        .info-panel {
            background: #f8f9fa;
            padding: 0.5rem 1rem;
            font-size: 14px;
            color: #666;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.95);
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            text-align: center;
            width: 80%;
            max-width: 400px;
        }
        
        .loading.hidden {
            display: none;
        }
        
        .progress-bar {
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            margin-top: 1rem;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background: #1e5799;
            width: 0%;
            transition: width 0.3s;
        }
        
        /* Custom popup styles */
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            padding: 0;
            overflow: hidden;
        }
        
        .popup-content {
            max-width: 350px;
        }
        
        .popup-header {
            background: #1e5799;
            color: white;
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .popup-tabs {
            display: flex;
            border-bottom: 1px solid #eee;
        }
        
        .popup-tab {
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 14px;
            border-bottom: 2px solid transparent;
        }
        
        .popup-tab.active {
            border-bottom: 2px solid #1e5799;
            font-weight: 600;
        }
        
        .popup-tab-content {
            padding: 1rem;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .popup-tab-pane {
            display: none;
        }
        
        .popup-tab-pane.active {
            display: block;
        }
        
        .field {
            margin-bottom: 0.4rem;
            font-size: 14px;
            display: flex;
        }
        
        .field strong {
            color: #555;
            min-width: 120px;
        }
        
        .field span {
            color: #777;
            flex: 1;
            word-break: break-word;
        }
        
        .legend {
            background: white;
            padding: 0.8rem;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            line-height: 1.4;
            max-width: 200px;
        }
        
        .legend-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #1e5799;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.3rem;
        }
        
        .legend-color {
            width: 20px;
            height: 3px;
            margin-right: 0.7rem;
        }
        
        .legend-circle {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.7rem;
        }
        
        .legend-area {
            width: 20px;
            height: 12px;
            margin-right: 0.7rem;
            opacity: 0.5;
        }
        
        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem;
        }
        
        .stats {
            display: flex;
            gap: 0.5rem;
            font-size: 12px;
            flex-wrap: wrap;
        }
        
        .stat-item {
            background: rgba(30, 87, 153, 0.1);
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .export-btn {
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0.3rem 0.6rem;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .export-btn:hover {
            background: #218838;
        }
        
        .report-btn {
            background: #6f42c1;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0.3rem 0.6rem;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .report-btn:hover {
            background: #5a32a3;
        }
        
        .toggle-filters-btn {
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0.3rem 0.6rem;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .toggle-filters-btn:hover {
            background: #5a6268;
        }
        
        .report-container {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            padding: 1.5rem;
            z-index: 1000;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            display: none;
        }
        
        .report-container.active {
            display: block;
        }
        
        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
        }
        
        .report-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1e5799;
        }
        
        .close-report {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        
        .report-content {
            font-size: 14px;
            line-height: 1.6;
        }
        
        .report-section {
            margin-bottom: 1.5rem;
        }
        
        .report-section-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #207cca;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .report-item {
            margin-bottom: 0.3rem;
            padding-left: 1.5rem;
            position: relative;
        }
        
        .report-item:before {
            content: '‚Ä¢';
            position: absolute;
            left: 0;
            color: #1e5799;
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .controls-container {
                padding: 0.8rem;
            }
            
            .layer-controls {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .layer-control-group {
                width: 100%;
            }
            
            .info-panel {
                flex-direction: column;
            }
            
            .stats {
                width: 100%;
                justify-content: space-between;
            }
            
            .report-container {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1><i class="fas fa-map-marked-alt"></i> Geovisor - Informaci√≥n Geogr√°fica Cant√≥n Azogues</h1>
    </div>
    
    <div class="controls-container">
        <div class="layer-controls">
            <div class="layer-control-group">
                <button class="layer-toggle-btn active" id="toggleRios" title="Mostrar capa de r√≠os">
                    <i class="fas fa-water"></i> R√≠os
                </button>
                <button class="layer-visibility-btn" id="visibilityRios" title="Mostrar/ocultar r√≠os">
                    <i class="fas fa-eye"></i>
                </button>
            </div>
            
            <div class="layer-control-group">
                <button class="layer-toggle-btn" id="toggleVias" title="Mostrar capa de v√≠as">
                    <i class="fas fa-road"></i> V√≠as
                </button>
                <button class="layer-visibility-btn" id="visibilityVias" title="Mostrar/ocultar v√≠as">
                    <i class="fas fa-eye"></i>
                </button>
            </div>
            
            <div class="layer-control-group">
                <button class="layer-toggle-btn" id="togglePoblados" title="Mostrar capa de poblados">
                    <i class="fas fa-home"></i> Poblados
                </button>
                <button class="layer-visibility-btn" id="visibilityPoblados" title="Mostrar/ocultar poblados">
                    <i class="fas fa-eye"></i>
                </button>
            </div>
            
            <div class="layer-control-group">
                <button class="layer-toggle-btn" id="toggleCurvas" title="Mostrar capa de curvas">
                    <i class="fas fa-mountain"></i> Curvas
                </button>
                <button class="layer-visibility-btn" id="visibilityCurvas" title="Mostrar/ocultar curvas">
                    <i class="fas fa-eye"></i>
                </button>
            </div>
            
            <div class="layer-control-group">
                <button class="layer-toggle-btn" id="toggleAreas" title="Mostrar capa de √°reas">
                    <i class="fas fa-tree"></i> √Åreas
                </button>
                <button class="layer-visibility-btn" id="visibilityAreas" title="Mostrar/ocultar √°reas">
                    <i class="fas fa-eye"></i>
                </button>
            </div>
        </div>
        
        <div class="search-container">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Buscar por nombre..." />
                <button onclick="buscarElemento()"><i class="fas fa-search"></i> Buscar</button>
                <button onclick="limpiarBusqueda()"><i class="fas fa-times"></i> Limpiar</button>
                <button class="toggle-filters-btn" id="toggleFiltersBtn" onclick="toggleAdvancedFilters()">
                    <i class="fas fa-filter"></i> Filtros
                </button>
                <button class="export-btn" onclick="exportarDatos()">
                    <i class="fas fa-file-export"></i> Exportar
                </button>
                <button class="report-btn" onclick="generarReporte()">
                    <i class="fas fa-file-alt"></i> Reporte
                </button>
            </div>
            
            <div class="advanced-filters" id="advancedFilters">
                <div class="filter-group">
                    <label for="filterField">Campo:</label>
                    <select id="filterField">
                        <option value="nam">Nombre</option>
                        <option value="descriptio">Descripci√≥n</option>
                        <option value="fcode">C√≥digo</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filterValue">Valor:</label>
                    <input type="text" id="filterValue" placeholder="Valor a filtrar">
                </div>
                <button class="btn btn-sm btn-primary" onclick="aplicarFiltro()">Aplicar Filtro</button>
                <button class="btn btn-sm btn-secondary" onclick="limpiarFiltro()">Limpiar Filtro</button>
            </div>
        </div>
    </div>
    
    <div class="info-panel">
        <span id="infoText">Cargando datos geogr√°ficos...</span>
        <div class="stats">
            <div class="stat-item" id="riosStat"><i class="fas fa-water"></i> R√≠os: 0</div>
            <div class="stat-item" id="viasStat"><i class="fas fa-road"></i> V√≠as: 0</div>
            <div class="stat-item" id="pobladosStat"><i class="fas fa-home"></i> Poblados: 0</div>
            <div class="stat-item" id="curvasStat"><i class="fas fa-mountain"></i> Curvas: 0</div>
            <div class="stat-item" id="areasStat"><i class="fas fa-tree"></i> √Åreas: 0</div>
        </div>
    </div>
    
    <div class="map-container">
        <div id="loading" class="loading">
            <div><i class="fas fa-globe-americas fa-2x" style="color: #1e5799; margin-bottom: 1rem;"></i></div>
            <div>üåç Cargando datos geogr√°ficos...</div>
            <div id="loadingDetail" style="margin-top: 0.5rem; font-size: 14px; color: #666;">
                Iniciando conexi√≥n con Supabase
            </div>
            <div class="progress-bar">
                <div class="progress" id="progressBar"></div>
            </div>
        </div>
        <div id="map"></div>
        
        <!-- Reporte de datos -->
        <div id="reportContainer" class="report-container">
            <div class="report-header">
                <div class="report-title"><i class="fas fa-file-alt"></i> Reporte de Datos</div>
                <button class="close-report" onclick="document.getElementById('reportContainer').classList.remove('active')">&times;</button>
            </div>
            <div class="report-content" id="reportContent">
                Cargando reporte...
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <!-- Font Awesome JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <!-- PapaParse para exportar CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    
    <script>
        // Configuraci√≥n Supabase
        const SUPABASE_URL = 'https://dpgnbjydxxyugorzfodu.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRwZ25ianlkeHh5dWdvcnpmb2R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA0Mzg0NjYsImV4cCI6MjA2NjAxNDQ2Nn0.QB6wkPO_HnCP1AuG3U9XwXHRYk7dOwflfFT_ONdn5Zg';
        
        let map;
        let riosLayer = L.layerGroup();
        let viasLayer = L.layerGroup();
        let pobladosLayer = L.layerGroup();
        let curvasLayer = L.layerGroup();
        let areasLayer = L.layerGroup();
        let allRios = [];
        let allVias = [];
        let allPoblados = [];
        let allCurvas = [];
        let allAreas = [];
        let currentLayer = 'rios';
        let hasDataLoaded = false;
        let layerVisibility = {
            rios: true,
            vias: true,
            poblados: true,
            curvas: true,
            areas: true
        };
        let currentFilters = {
            field: '',
            value: ''
        };
        
        // Coordenadas centrales del Cant√≥n Azogues
        const AZOGUES_CENTER = [-2.7397, -78.8486];
        const AZOGUES_ZOOM = 12;
        
        // Inicializar mapa centrado en Azogues
        function initMap() {
            map = L.map('map').setView(AZOGUES_CENTER, AZOGUES_ZOOM);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            riosLayer.addTo(map);
            
            // Leyenda
            const legend = L.control({position: 'bottomright'});
            legend.onAdd = function() {
                const div = L.DomUtil.create('div', 'legend');
                div.innerHTML = `
                    <div class="legend-title"><i class="fas fa-map-signs"></i> Leyenda</div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color:#1e90ff"></div>
                        <span>R√≠os</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color:#2f4f4f"></div>
                        <span>V√≠as</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-circle" style="background-color:#ff8c00"></div>
                        <span>Poblados</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color:#ff0000"></div>
                        <span>Curvas (Alta)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color:#ff9900"></div>
                        <span>Curvas (Media)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color:#00ff00"></div>
                        <span>Curvas (Baja)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-area" style="background-color:#8a2be2"></div>
                        <span>√Åreas Protegidas</span>
                    </div>
                `;
                return div;
            };
            legend.addTo(map);
        }
        
        // Obtener color seg√∫n la elevaci√≥n para curvas
        function getColorByElevation(elevation) {
            if (elevation > 3000) return '#ff0000';
            if (elevation > 1500) return '#ff9900';
            return '#00ff00';
        }
        
        // Actualizar barra de progreso
        function updateProgress(percent, text) {
            const progressBar = document.getElementById('progressBar');
            const loadingDetail = document.getElementById('loadingDetail');
            
            if (progressBar) progressBar.style.width = percent + '%';
            if (loadingDetail) loadingDetail.textContent = text;
        }
        
        // Cargar datos de Supabase
        async function cargarDatos() {
            const loading = document.getElementById('loading');
            const infoText = document.getElementById('infoText');
            
            try {
                infoText.textContent = 'Conectando con Supabase...';
                updateProgress(10, 'Iniciando conexi√≥n');
                
                // 1. Cargar r√≠os (rio_l)
                updateProgress(15, 'Cargando r√≠os...');
                const riosResponse = await fetch(`${SUPABASE_URL}/rest/v1/rio_l?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!riosResponse.ok) {
                    const errorText = await riosResponse.text();
                    throw new Error(`Error cargando r√≠os: ${riosResponse.status} - ${errorText}`);
                }
                
                allRios = await riosResponse.json();
                procesarRios(allRios);
                document.getElementById('riosStat').textContent = `R√≠os: ${allRios.length}`;
                
                // 2. Cargar v√≠as (via_l)
                updateProgress(25, 'Cargando v√≠as...');
                const viasResponse = await fetch(`${SUPABASE_URL}/rest/v1/via_l?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!viasResponse.ok) {
                    const errorText = await viasResponse.text();
                    throw new Error(`Error cargando v√≠as: ${viasResponse.status} - ${errorText}`);
                }
                
                allVias = await viasResponse.json();
                procesarVias(allVias);
                document.getElementById('viasStat').textContent = `V√≠as: ${allVias.length}`;
                
                // 3. Cargar poblados (poblado_p)
                updateProgress(35, 'Cargando poblados...');
                const pobladosResponse = await fetch(`${SUPABASE_URL}/rest/v1/poblado_p?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!pobladosResponse.ok) {
                    const errorText = await pobladosResponse.text();
                    throw new Error(`Error cargando poblados: ${pobladosResponse.status} - ${errorText}`);
                }
                
                allPoblados = await pobladosResponse.json();
                procesarPoblados(allPoblados);
                document.getElementById('pobladosStat').textContent = `Poblados: ${allPoblados.length}`;
                
                // 4. Cargar curvas de nivel (curva_nivel_l)
                updateProgress(55, 'Cargando curvas de nivel...');
                const curvasResponse = await fetch(`${SUPABASE_URL}/rest/v1/curva_nivel_l?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!curvasResponse.ok) {
                    const errorText = await curvasResponse.text();
                    throw new Error(`Error cargando curvas: ${curvasResponse.status} - ${errorText}`);
                }
                
                allCurvas = await curvasResponse.json();
                procesarCurvas(allCurvas);
                document.getElementById('curvasStat').textContent = `Curvas: ${allCurvas.length}`;
                
                // 5. Cargar √°reas protegidas (nombres_areas_p)
                updateProgress(75, 'Cargando √°reas protegidas...');
                const areasResponse = await fetch(`${SUPABASE_URL}/rest/v1/nombres_areas_p?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!areasResponse.ok) {
                    const errorText = await areasResponse.text();
                    throw new Error(`Error cargando √°reas: ${areasResponse.status} - ${errorText}`);
                }
                
                allAreas = await areasResponse.json();
                procesarAreas(allAreas);
                document.getElementById('areasStat').textContent = `√Åreas: ${allAreas.length}`;
                
                // Finalizar carga
                updateProgress(100, 'Carga completada');
                setTimeout(() => {
                    loading.classList.add('hidden');
                    hasDataLoaded = true;
                    infoText.textContent = `‚úÖ Datos cargados correctamente`;
                    
                    // Ajustar vista al Cant√≥n Azogues con zoom √≥ptimo
                    map.setView(AZOGUES_CENTER, AZOGUES_ZOOM);
                    
                }, 500);
                
            } catch (error) {
                console.error('Error cargando datos:', error);
                loading.classList.add('hidden');
                infoText.textContent = `‚ùå Error: ${error.message}`;
                
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.innerHTML = `
                    <strong>Error al cargar los datos:</strong> ${error.message}<br>
                    Verifique: 
                    <ul>
                        <li>La conexi√≥n a internet</li>
                        <li>La configuraci√≥n de Supabase</li>
                        <li>Los permisos de las tablas</li>
                    </ul>
                `;
                document.querySelector('.map-container').appendChild(errorDiv);
            }
        }
        
        // Procesar r√≠os
        function procesarRios(rios) {
            riosLayer.clearLayers();
            
            if (!rios || rios.length === 0) {
                console.warn('No hay datos de r√≠os para procesar');
                return;
            }
            
            const features = [];
            
            for (const rio of rios) {
                try {
                    if (!rio.geom) continue;
                    
                    // Manejar geometr√≠a
                    let geometry = rio.geom;
                    if (typeof geometry === 'string') {
                        try {
                            geometry = JSON.parse(geometry);
                        } catch (e) {
                            console.warn('Error parseando geometr√≠a de r√≠o:', rio);
                            continue;
                        }
                    }
                    
                    // Crear feature
                    const feature = {
                        type: 'Feature',
                        properties: rio,
                        geometry: geometry
                    };
                    
                    features.push(feature);
                    
                } catch (error) {
                    console.warn('Error procesando r√≠o:', rio, error);
                }
            }
            
            // Crear capa GeoJSON
            if (features.length > 0) {
                const geoJsonLayer = L.geoJSON(features, {
                    style: {
                        color: '#1e90ff',
                        weight: 2,
                        opacity: 0.8
                    },
                    onEachFeature: function(feature, layer) {
                        const popupContent = crearPopupRio(feature.properties);
                        layer.bindPopup(popupContent);
                    }
                });
                
                geoJsonLayer.addTo(riosLayer);
            }
        }
        
        // Procesar v√≠as
        function procesarVias(vias) {
            viasLayer.clearLayers();
            
            if (!vias || vias.length === 0) {
                console.warn('No hay datos de v√≠as para procesar');
                return;
            }
            
            const features = [];
            
            for (const via of vias) {
                try {
                    if (!via.geom) continue;
                    
                    // Manejar geometr√≠a
                    let geometry = via.geom;
                    if (typeof geometry === 'string') {
                        try {
                            geometry = JSON.parse(geometry);
                        } catch (e) {
                            console.warn('Error parseando geometr√≠a de v√≠a:', via);
                            continue;
                        }
                    }
                    
                    // Crear feature
                    const feature = {
                        type: 'Feature',
                        properties: via,
                        geometry: geometry
                    };
                    
                    features.push(feature);
                    
                } catch (error) {
                    console.warn('Error procesando v√≠a:', via, error);
                }
            }
            
            // Crear capa GeoJSON
            if (features.length > 0) {
                const geoJsonLayer = L.geoJSON(features, {
                    style: {
                        color: '#2f4f4f',
                        weight: 3,
                        opacity: 0.8
                    },
                    onEachFeature: function(feature, layer) {
                        const popupContent = crearPopupVia(feature.properties);
                        layer.bindPopup(popupContent);
                    }
                });
                
                geoJsonLayer.addTo(viasLayer);
            }
        }
        
        // Procesar poblados
        function procesarPoblados(poblados) {
            pobladosLayer.clearLayers();
            
            if (!poblados || poblados.length === 0) {
                console.warn('No hay datos de poblados para procesar');
                return;
            }
            
            const features = [];
            
            for (const poblado of poblados) {
                try {
                    if (!poblado.geom) continue;
                    
                    // Manejar geometr√≠a
                    let geometry = poblado.geom;
                    if (typeof geometry === 'string') {
                        try {
                            geometry = JSON.parse(geometry);
                        } catch (e) {
                            console.warn('Error parseando geometr√≠a de poblado:', poblado);
                            continue;
                        }
                    }
                    
                    // Crear feature
                    const feature = {
                        type: 'Feature',
                        properties: poblado,
                        geometry: geometry
                    };
                    
                    features.push(feature);
                    
                } catch (error) {
                    console.warn('Error procesando poblado:', poblado, error);
                }
            }
            
            // Crear capa GeoJSON
            if (features.length > 0) {
                const geoJsonLayer = L.geoJSON(features, {
                    pointToLayer: function(feature, latlng) {
                        return L.circleMarker(latlng, {
                            radius: 6,
                            fillColor: '#ff8c00',
                            color: '#cc7000',
                            weight: 1,
                            opacity: 1,
                            fillOpacity: 0.8
                        });
                    },
                    onEachFeature: function(feature, layer) {
                        const popupContent = crearPopupPoblado(feature.properties);
                        layer.bindPopup(popupContent);
                    }
                });
                
                geoJsonLayer.addTo(pobladosLayer);
            }
        }
        
        // Procesar curvas de nivel
        function procesarCurvas(curvas) {
            curvasLayer.clearLayers();
            
            if (!curvas || curvas.length === 0) {
                console.warn('No hay datos de curvas para procesar');
                return;
            }
            
            const features = [];
            
            for (const curva of curvas) {
                try {
                    if (!curva.geom) continue;
                    
                    // Manejar geometr√≠a
                    let geometry = curva.geom;
                    if (typeof geometry === 'string') {
                        try {
                            geometry = JSON.parse(geometry);
                        } catch (e) {
                            console.warn('Error parseando geometr√≠a de curva:', curva);
                            continue;
                        }
                    }
                    
                    // Extraer elevaci√≥n (suponiendo que est√° en el campo "crv")
                    const elevation = curva.crv || 0;
                    
                    // Crear feature
                    const feature = {
                        type: 'Feature',
                        properties: {
                            ...curva,
                            elevation: elevation
                        },
                        geometry: geometry
                    };
                    
                    features.push(feature);
                    
                } catch (error) {
                    console.warn('Error procesando curva:', curva, error);
                }
            }
            
            // Crear capa GeoJSON
            if (features.length > 0) {
                const geoJsonLayer = L.geoJSON(features, {
                    style: function(feature) {
                        return {
                            color: getColorByElevation(feature.properties.elevation || 0),
                            weight: 1,
                            opacity: 0.7
                        };
                    },
                    onEachFeature: function(feature, layer) {
                        const popupContent = crearPopupCurva(feature.properties);
                        layer.bindPopup(popupContent);
                    }
                });
                
                geoJsonLayer.addTo(curvasLayer);
            }
        }
        
        // Procesar √°reas protegidas
        function procesarAreas(areas) {
            areasLayer.clearLayers();
            
            if (!areas || areas.length === 0) {
                console.warn('No hay datos de √°reas para procesar');
                return;
            }
            
            const features = [];
            
            for (const area of areas) {
                try {
                    if (!area.geom) continue;
                    
                    // Manejar geometr√≠a
                    let geometry = area.geom;
                    if (typeof geometry === 'string') {
                        try {
                            geometry = JSON.parse(geometry);
                        } catch (e) {
                            console.warn('Error parseando geometr√≠a de √°rea:', area);
                            continue;
                        }
                    }
                    
                    // Crear feature
                    const feature = {
                        type: 'Feature',
                        properties: area,
                        geometry: geometry
                    };
                    
                    features.push(feature);
                    
                } catch (error) {
                    console.warn('Error procesando √°rea:', area, error);
                }
            }
            
            // Crear capa GeoJSON
            if (features.length > 0) {
                const geoJsonLayer = L.geoJSON(features, {
                    style: {
                        color: '#8a2be2',
                        weight: 2,
                        opacity: 0.8,
                        fillColor: '#8a2be2',
                        fillOpacity: 0.3
                    },
                    onEachFeature: function(feature, layer) {
                        const popupContent = crearPopupArea(feature.properties);
                        layer.bindPopup(popupContent);
                    }
                });
                
                geoJsonLayer.addTo(areasLayer);
            }
        }
        
        // Crear popup para r√≠os
        function crearPopupRio(rio) {
            const generalFields = [
                { label: 'Nombre', value: rio.nam },
                { label: 'C√≥digo', value: rio.fcode },
                { label: 'Descripci√≥n', value: rio.descripcio },
                { label: 'Naz', value: rio.naz }
            ];
            
            const detallesFields = [
                { label: 'Sec', value: rio.sec },
                { label: 'Sec Desc', value: rio.sec_desc },
                { label: 'Hyp', value: rio.hyp },
                { label: 'Hyp Desc', value: rio.hyp_desc },
                { label: 'Longitud', value: rio.Shape_Leng ? `${rio.Shape_Leng.toFixed(2)} m` : null }
            ];
            
            const otrosFields = Object.entries(rio)
                .filter(([key]) => !['nam', 'fcode', 'descripcio', 'naz', 'sec', 'sec_desc', 'hyp', 'hyp_desc', 'Shape_Leng', 'geom'].includes(key))
                .map(([key, value]) => ({ label: key, value }));
            
            return crearPopupConPestanas('R√≠o', 'fa-water', generalFields, detallesFields, otrosFields);
        }
        
        // Crear popup para v√≠as
        function crearPopupVia(via) {
            const generalFields = [
                { label: 'Nombre', value: via.nam },
                { label: 'Descripci√≥n', value: via.descriptio }
            ];
            
            const detallesFields = [
                { label: 'Acc', value: via.acc },
                { label: 'Acc Desc', value: via.acc_desc },
                { label: 'Rst', value: via.rst },
                { label: 'Rst Desc', value: via.rst_desc },
                { label: 'Typ', value: via.typ },
                { label: 'Typ Desc', value: via.typ_desc }
            ];
            
            const otrosFields = Object.entries(via)
                .filter(([key]) => !['nam', 'descriptio', 'acc', 'acc_desc', 'rst', 'rst_desc', 'typ', 'typ_desc', 'geom'].includes(key))
                .map(([key, value]) => ({ label: key, value }));
            
            return crearPopupConPestanas('V√≠a', 'fa-road', generalFields, detallesFields, otrosFields);
        }
        
        // Crear popup para poblados
        function crearPopupPoblado(poblado) {
            const generalFields = [
                { label: 'Nombre', value: poblado.nam },
                { label: 'C√≥digo', value: poblado.fcode },
                { label: 'Descripci√≥n', value: poblado.descriptio }
            ];
            
            const detallesFields = [
                { label: 'Naz', value: poblado.naz },
                { label: 'Ppt', value: poblado.ppt },
                { label: 'Ppt Desc', value: poblado.ppt_desc },
                { label: 'Nuts', value: poblado.nuts }
            ];
            
            const otrosFields = Object.entries(poblado)
                .filter(([key]) => !['nam', 'fcode', 'descriptio', 'naz', 'ppt', 'ppt_desc', 'nuts', 'geom'].includes(key))
                .map(([key, value]) => ({ label: key, value }));
            
            return crearPopupConPestanas('Poblado', 'fa-home', generalFields, detallesFields, otrosFields);
        }
        
        // Crear popup para curvas de nivel
        function crearPopupCurva(curva) {
            const generalFields = [
                { label: 'Nombre', value: curva.foods },
                { label: 'ID', value: curva.id },
                { label: 'Descripci√≥n', value: curva.descriptio },
                { label: 'Elevaci√≥n', value: curva.crv ? `${curva.crv} m` : null }
            ];
            
            const detallesFields = [
                { label: 'Acc', value: curva.acc },
                { label: 'Acc Desc', value: curva.acc_desc },
                { label: 'HQC', value: curva.hqc },
                { label: 'HQC Desc', value: curva.hqc_desc },
                { label: 'ELA', value: curva.ela },
                { label: 'ELA Desc', value: curva.ela_desc },
                { label: 'Longitud', value: curva.SHAPE_Leng ? `${curva.SHAPE_Leng.toFixed(2)} m` : null }
            ];
            
            const otrosFields = Object.entries(curva)
                .filter(([key]) => !['foods', 'id', 'descriptio', 'crv', 'acc', 'acc_desc', 'hqc', 'hqc_desc', 'ela', 'ela_desc', 'SHAPE_Leng', 'geom'].includes(key))
                .map(([key, value]) => ({ label: key, value }));
            
            return crearPopupConPestanas('Curva de Nivel', 'fa-mountain', generalFields, detallesFields, otrosFields);
        }
        
        // Crear popup para √°reas protegidas
        function crearPopupArea(area) {
            const generalFields = [
                { label: 'Nombre', value: area.nam },
                { label: 'ID', value: area.id },
                { label: 'C√≥digo', value: area.icode },
                { label: 'Descripci√≥n', value: area.descriptio }
            ];
            
            const detallesFields = [
                { label: 'Foods', value: area.foods },
                { label: 'Info', value: area.txt }
            ];
            
            const otrosFields = Object.entries(area)
                .filter(([key]) => !['nam', 'id', 'icode', 'descriptio', 'foods', 'txt', 'geom'].includes(key))
                .map(([key, value]) => ({ label: key, value }));
            
            return crearPopupConPestanas('√Årea Protegida', 'fa-tree', generalFields, detallesFields, otrosFields);
        }
        
        // Crear popup con pesta√±as
        function crearPopupConPestanas(titulo, icono, generalFields, detallesFields, otrosFields) {
            const generalContent = generalFields
                .filter(field => field.value !== null && field.value !== undefined && field.value !== '')
                .map(field => `
                    <div class="field">
                        <strong>${field.label}:</strong>
                        <span>${field.value}</span>
                    </div>
                `).join('');
            
            const detallesContent = detallesFields
                .filter(field => field.value !== null && field.value !== undefined && field.value !== '')
                .map(field => `
                    <div class="field">
                        <strong>${field.label}:</strong>
                        <span>${field.value}</span>
                    </div>
                `).join('');
            
            const otrosContent = otrosFields
                .filter(field => field.value !== null && field.value !== undefined && field.value !== '')
                .map(field => `
                    <div class="field">
                        <strong>${field.label}:</strong>
                        <span>${field.value}</span>
                    </div>
                `).join('');
            
            return `
                <div class="popup-content">
                    <div class="popup-header">
                        <i class="fas ${icono}"></i>
                        <h3>${titulo}</h3>
                    </div>
                    <div class="popup-tabs">
                        <div class="popup-tab active" onclick="cambiarPestana(this, 'general')">General</div>
                        <div class="popup-tab" onclick="cambiarPestana(this, 'detalles')">Detalles</div>
                        <div class="popup-tab" onclick="cambiarPestana(this, 'otros')">Otros</div>
                    </div>
                    <div class="popup-tab-content">
                        <div class="popup-tab-pane active" id="general">
                            ${generalContent || '<p>No hay informaci√≥n general disponible</p>'}
                        </div>
                        <div class="popup-tab-pane" id="detalles">
                            ${detallesContent || '<p>No hay detalles adicionales</p>'}
                        </div>
                        <div class="popup-tab-pane" id="otros">
                            ${otrosContent || '<p>No hay otros campos con informaci√≥n</p>'}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Alternar entre capas
        function toggleLayer(layer) {
            currentLayer = layer;
            
            // Quitar clase activa de todos los botones
            document.querySelectorAll('.layer-toggle-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Activar el bot√≥n seleccionado
            document.getElementById(`toggle${capitalizeFirstLetter(layer)}`).classList.add('active');
            
            // Actualizar mensaje de informaci√≥n
            const layerNames = {
                rios: 'r√≠os',
                vias: 'v√≠as',
                poblados: 'poblados',
                curvas: 'curvas de nivel',
                areas: '√°reas protegidas'
            };
            
            document.getElementById('infoText').textContent = `‚úÖ Capa de ${layerNames[layer]} activa`;
            
            // Si la capa est√° oculta, mostrarla al activarla
            if (!layerVisibility[layer]) {
                toggleLayerVisibility(layer);
            }
        }
        
        // Alternar visibilidad de capas
        function toggleLayerVisibility(layer) {
            const visibilityBtn = document.getElementById(`visibility${capitalizeFirstLetter(layer)}`);
            
            if (layerVisibility[layer]) {
                // Ocultar capa
                if (layer === 'rios') riosLayer.remove();
                if (layer === 'vias') viasLayer.remove();
                if (layer === 'poblados') pobladosLayer.remove();
                if (layer === 'curvas') curvasLayer.remove();
                if (layer === 'areas') areasLayer.remove();
                
                visibilityBtn.innerHTML = '<i class="fas fa-eye-slash"></i>';
                visibilityBtn.title = 'Mostrar ' + layer;
            } else {
                // Mostrar capa
                if (layer === 'rios') riosLayer.addTo(map);
                if (layer === 'vias') viasLayer.addTo(map);
                if (layer === 'poblados') pobladosLayer.addTo(map);
                if (layer === 'curvas') curvasLayer.addTo(map);
                if (layer === 'areas') areasLayer.addTo(map);
                
                visibilityBtn.innerHTML = '<i class="fas fa-eye"></i>';
                visibilityBtn.title = 'Ocultar ' + layer;
            }
            
            layerVisibility[layer] = !layerVisibility[layer];
        }
        
        // Capitalizar primera letra
        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }
        
        // Cambiar pesta√±a en popup
        function cambiarPestana(tabElement, tabId) {
            const popupContent = tabElement.closest('.popup-content');
            
            // Desactivar todas las pesta√±as
            popupContent.querySelectorAll('.popup-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            popupContent.querySelectorAll('.popup-tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            
            // Activar la pesta√±a seleccionada
            tabElement.classList.add('active');
            popupContent.querySelector(`#${tabId}`).classList.add('active');
        }
        
        // Alternar filtros avanzados
        function toggleAdvancedFilters() {
            const filters = document.getElementById('advancedFilters');
            filters.classList.toggle('active');
        }
        
        // Aplicar filtro avanzado
        function aplicarFiltro() {
            const field = document.getElementById('filterField').value;
            const value = document.getElementById('filterValue').value.trim().toLowerCase();
            
            if (!value) {
                alert('Por favor ingrese un valor para filtrar');
                return;
            }
            
            currentFilters.field = field;
            currentFilters.value = value;
            
            let elementosFiltrados = [];
            let tipoElemento = '';
            
            if (currentLayer === 'rios') {
                elementosFiltrados = allRios.filter(rio => {
                    const campo = rio[field];
                    return campo && campo.toString().toLowerCase().includes(value);
                });
                tipoElemento = 'r√≠os';
                procesarRios(elementosFiltrados);
            } 
            else if (currentLayer === 'vias') {
                elementosFiltrados = allVias.filter(via => {
                    const campo = via[field];
                    return campo && campo.toString().toLowerCase().includes(value);
                });
                tipoElemento = 'v√≠as';
                procesarVias(elementosFiltrados);
            } 
            else if (currentLayer === 'poblados') {
                elementosFiltrados = allPoblados.filter(poblado => {
                    const campo = poblado[field];
                    return campo && campo.toString().toLowerCase().includes(value);
                });
                tipoElemento = 'poblados';
                procesarPoblados(elementosFiltrados);
            }
            else if (currentLayer === 'curvas') {
                elementosFiltrados = allCurvas.filter(curva => {
                    const campo = curva[field];
                    return campo && campo.toString().toLowerCase().includes(value);
                });
                tipoElemento = 'curvas de nivel';
                procesarCurvas(elementosFiltrados);
            }
            else if (currentLayer === 'areas') {
                elementosFiltrados = allAreas.filter(area => {
                    const campo = area[field];
                    return campo && campo.toString().toLowerCase().includes(value);
                });
                tipoElemento = '√°reas protegidas';
                procesarAreas(elementosFiltrados);
            }
            
            if (elementosFiltrados.length === 0) {
                document.getElementById('infoText').textContent = `‚ùå No se encontraron ${tipoElemento} con ${field}="${value}"`;
            } else {
                document.getElementById('infoText').textContent = `üîç ${elementosFiltrados.length} ${tipoElemento} encontrados con ${field}="${value}"`;
                
                // Ajustar vista a los resultados
                let group;
                if (currentLayer === 'rios' && riosLayer.getLayers().length > 0) {
                    group = new L.featureGroup(riosLayer.getLayers());
                } 
                else if (currentLayer === 'vias' && viasLayer.getLayers().length > 0) {
                    group = new L.featureGroup(viasLayer.getLayers());
                } 
                else if (currentLayer === 'poblados' && pobladosLayer.getLayers().length > 0) {
                    group = new L.featureGroup(pobladosLayer.getLayers());
                }
                else if (currentLayer === 'curvas' && curvasLayer.getLayers().length > 0) {
                    group = new L.featureGroup(curvasLayer.getLayers());
                }
                else if (currentLayer === 'areas' && areasLayer.getLayers().length > 0) {
                    group = new L.featureGroup(areasLayer.getLayers());
                }
                
                if (group) {
                    map.fitBounds(group.getBounds(), { padding: [20, 20] });
                }
            }
        }
        
        // Limpiar filtro avanzado
        function limpiarFiltro() {
            document.getElementById('filterValue').value = '';
            currentFilters.field = '';
            currentFilters.value = '';
            
            if (currentLayer === 'rios') {
                procesarRios(allRios);
                document.getElementById('infoText').textContent = `‚úÖ Capa de r√≠os activa`;
            } 
            else if (currentLayer === 'vias') {
                procesarVias(allVias);
                document.getElementById('infoText').textContent = `‚úÖ Capa de v√≠as activa`;
            } 
            else if (currentLayer === 'poblados') {
                procesarPoblados(allPoblados);
                document.getElementById('infoText').textContent = `‚úÖ Capa de poblados activa`;
            }
            else if (currentLayer === 'curvas') {
                procesarCurvas(allCurvas);
                document.getElementById('infoText').textContent = `‚úÖ Capa de curvas activa`;
            }
            else if (currentLayer === 'areas') {
                procesarAreas(allAreas);
                document.getElementById('infoText').textContent = `‚úÖ Capa de √°reas activa`;
            }
        }
        
        // Funci√≥n de b√∫squeda
        function buscarElemento() {
            if (!hasDataLoaded) {
                alert('Los datos a√∫n se est√°n cargando. Por favor espere.');
                return;
            }
            
            const searchTerm = document.getElementById('searchInput').value.trim();
            if (!searchTerm) return;
            
            let elementosEncontrados = [];
            let tipoElemento = '';
            
            if (currentLayer === 'rios') {
                elementosEncontrados = allRios.filter(rio => {
                    const campos = [
                        rio.nam,
                        rio.descripcio,
                        rio.naz,
                        rio.txt
                    ].filter(Boolean).map(c => c.toString().toLowerCase());
                    
                    return campos.some(campo => campo.includes(searchTerm.toLowerCase()));
                });
                tipoElemento = 'r√≠os';
                
                // Procesar resultados
                if (elementosEncontrados.length > 0) {
                    procesarRios(elementosEncontrados);
                    
                    // Ajustar vista a los resultados
                    if (riosLayer.getLayers().length > 0) {
                        const group = new L.featureGroup(riosLayer.getLayers());
                        map.fitBounds(group.getBounds(), { padding: [20, 20] });
                    }
                }
            } 
            else if (currentLayer === 'vias') {
                elementosEncontrados = allVias.filter(via => {
                    const campos = [
                        via.nam,
                        via.descriptio,
                        via.acc_desc,
                        via.rst_desc,
                        via.txt
                    ].filter(Boolean).map(c => c.toString().toLowerCase());
                    
                    return campos.some(campo => campo.includes(searchTerm.toLowerCase()));
                });
                tipoElemento = 'v√≠as';
                
                // Procesar resultados
                if (elementosEncontrados.length > 0) {
                    procesarVias(elementosEncontrados);
                    
                    // Ajustar vista a los resultados
                    if (viasLayer.getLayers().length > 0) {
                        const group = new L.featureGroup(viasLayer.getLayers());
                        map.fitBounds(group.getBounds(), { padding: [20, 20] });
                    }
                }
            } 
            else if (currentLayer === 'poblados') {
                elementosEncontrados = allPoblados.filter(poblado => {
                    const campos = [
                        poblado.nam,
                        poblado.descriptio,
                        poblado.naz,
                        poblado.txt
                    ].filter(Boolean).map(c => c.toString().toLowerCase());
                    
                    return campos.some(campo => campo.includes(searchTerm.toLowerCase()));
                });
                tipoElemento = 'poblados';
                
                // Procesar resultados
                if (elementosEncontrados.length > 0) {
                    procesarPoblados(elementosEncontrados);
                    
                    // Ajustar vista a los resultados
                    if (pobladosLayer.getLayers().length > 0) {
                        const group = new L.featureGroup(pobladosLayer.getLayers());
                        map.fitBounds(group.getBounds(), { padding: [20, 20] });
                    }
                }
            }
            else if (currentLayer === 'curvas') {
                elementosEncontrados = allCurvas.filter(curva => {
                    const campos = [
                        curva.foods,
                        curva.descriptio,
                        curva.acc_desc,
                        curva.txt
                    ].filter(Boolean).map(c => c.toString().toLowerCase());
                    
                    return campos.some(campo => campo.includes(searchTerm.toLowerCase()));
                });
                tipoElemento = 'curvas de nivel';
                
                // Procesar resultados
                if (elementosEncontrados.length > 0) {
                    procesarCurvas(elementosEncontrados);
                    
                    // Ajustar vista a los resultados
                    if (curvasLayer.getLayers().length > 0) {
                        const group = new L.featureGroup(curvasLayer.getLayers());
                        map.fitBounds(group.getBounds(), { padding: [20, 20] });
                    }
                }
            }
            else if (currentLayer === 'areas') {
                elementosEncontrados = allAreas.filter(area => {
                    const campos = [
                        area.nam,
                        area.descriptio,
                        area.icode,
                        area.txt
                    ].filter(Boolean).map(c => c.toString().toLowerCase());
                    
                    return campos.some(campo => campo.includes(searchTerm.toLowerCase()));
                });
                tipoElemento = '√°reas protegidas';
                
                // Procesar resultados
                if (elementosEncontrados.length > 0) {
                    procesarAreas(elementosEncontrados);
                    
                    // Ajustar vista a los resultados
                    if (areasLayer.getLayers().length > 0) {
                        const group = new L.featureGroup(areasLayer.getLayers());
                        map.fitBounds(group.getBounds(), { padding: [20, 20] });
                    }
                }
            }
            
            if (elementosEncontrados.length === 0) {
                document.getElementById('infoText').textContent = `‚ùå No se encontraron ${tipoElemento} con "${searchTerm}"`;
            } else {
                document.getElementById('infoText').textContent = `üîç ${elementosEncontrados.length} ${tipoElemento} encontrados para "${searchTerm}"`;
            }
        }
        
        // Limpiar b√∫squeda
        function limpiarBusqueda() {
            document.getElementById('searchInput').value = '';
            
            if (currentLayer === 'rios') {
                procesarRios(allRios);
                document.getElementById('infoText').textContent = `‚úÖ Capa de r√≠os activa`;
            } 
            else if (currentLayer === 'vias') {
                procesarVias(allVias);
                document.getElementById('infoText').textContent = `‚úÖ Capa de v√≠as activa`;
            } 
            else if (currentLayer === 'poblados') {
                procesarPoblados(allPoblados);
                document.getElementById('infoText').textContent = `‚úÖ Capa de poblados activa`;
            }
            else if (currentLayer === 'curvas') {
                procesarCurvas(allCurvas);
                document.getElementById('infoText').textContent = `‚úÖ Capa de curvas activa`;
            }
            else if (currentLayer === 'areas') {
                procesarAreas(allAreas);
                document.getElementById('infoText').textContent = `‚úÖ Capa de √°reas activa`;
            }
        }
        
        // Exportar datos a CSV
        function exportarDatos() {
            if (!hasDataLoaded) {
                alert('Los datos a√∫n se est√°n cargando. Por favor espere.');
                return;
            }
            
            let datos = [];
            let nombreArchivo = '';
            
            if (currentLayer === 'rios') {
                datos = riosLayer.getLayers().map(layer => layer.feature.properties);
                nombreArchivo = 'rios_azogues.csv';
            } 
            else if (currentLayer === 'vias') {
                datos = viasLayer.getLayers().map(layer => layer.feature.properties);
                nombreArchivo = 'vias_azogues.csv';
            } 
            else if (currentLayer === 'poblados') {
                datos = pobladosLayer.getLayers().map(layer => layer.feature.properties);
                nombreArchivo = 'poblados_azogues.csv';
            }
            else if (currentLayer === 'curvas') {
                datos = curvasLayer.getLayers().map(layer => layer.feature.properties);
                nombreArchivo = 'curvas_azogues.csv';
            }
            else if (currentLayer === 'areas') {
                datos = areasLayer.getLayers().map(layer => layer.feature.properties);
                nombreArchivo = 'areas_azogues.csv';
            }
            
            if (datos.length === 0) {
                alert('No hay datos visibles para exportar en la capa actual');
                return;
            }
            
            // Eliminar geometr√≠a para reducir tama√±o del archivo
            datos = datos.map(item => {
                const { geom, ...rest } = item;
                return rest;
            });
            
            const csv = Papa.unparse(datos);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', nombreArchivo);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Generar reporte de datos
        function generarReporte() {
            if (!hasDataLoaded) {
                alert('Los datos a√∫n se est√°n cargando. Por favor espere.');
                return;
            }
            
            const reportContainer = document.getElementById('reportContainer');
            const reportContent = document.getElementById('reportContent');
            
            // Mostrar contenedor de reporte
            reportContainer.classList.add('active');
            
            // Crear contenido del reporte
            const fecha = new Date().toLocaleString();
            let reporteHTML = `
                <div class="report-section">
                    <div class="report-section-title">
                        <i class="fas fa-info-circle"></i> Informaci√≥n General
                    </div>
                    <div class="report-item">Fecha de generaci√≥n: ${fecha}</div>
                    <div class="report-item">Cant√≥n: Azogues</div>
                    <div class="report-item">Capa activa: ${capitalizeFirstLetter(currentLayer)}</div>
                </div>
                
                <div class="report-section">
                    <div class="report-section-title">
                        <i class="fas fa-layer-group"></i> Estad√≠sticas de Capas
                    </div>
                    <div class="report-item">R√≠os: ${allRios.length} elementos</div>
                    <div class="report-item">V√≠as: ${allVias.length} elementos</div>
                    <div class="report-item">Poblados: ${allPoblados.length} elementos</div>
                    <div class="report-item">Curvas de nivel: ${allCurvas.length} elementos</div>
                    <div class="report-item">√Åreas protegidas: ${allAreas.length} elementos</div>
                </div>
            `;
            
            // Detalles de la capa actual
            let capaActual = [];
            let nombreCapa = '';
            
            if (currentLayer === 'rios') {
                capaActual = allRios;
                nombreCapa = 'R√≠os';
            } 
            else if (currentLayer === 'vias') {
                capaActual = allVias;
                nombreCapa = 'V√≠as';
            } 
            else if (currentLayer === 'poblados') {
                capaActual = allPoblados;
                nombreCapa = 'Poblados';
            }
            else if (currentLayer === 'curvas') {
                capaActual = allCurvas;
                nombreCapa = 'Curvas de Nivel';
            }
            else if (currentLayer === 'areas') {
                capaActual = allAreas;
                nombreCapa = '√Åreas Protegidas';
            }
            
            if (capaActual.length > 0) {
                reporteHTML += `
                    <div class="report-section">
                        <div class="report-section-title">
                            <i class="fas fa-map-marker-alt"></i> Detalles de la Capa Actual (${nombreCapa})
                        </div>
                        <div class="report-item">Total de elementos: ${capaActual.length}</div>
                `;
                
                // Primeros 5 elementos
                const primerosElementos = capaActual.slice(0, 5);
                reporteHTML += `<div class="report-item">Primeros 5 elementos:</div>`;
                
                primerosElementos.forEach((elemento, index) => {
                    let nombre = elemento.nam || elemento.descriptio || elemento.foods || 'Elemento sin nombre';
                    reporteHTML += `<div class="report-item" style="margin-left: 20px;">${index + 1}. ${nombre}</div>`;
                });
                
                reporteHTML += `</div>`;
            }
            
            reportContent.innerHTML = reporteHTML;
        }
        
        // Inicializar cuando se carga la p√°gina
        window.addEventListener('DOMContentLoaded', function() {
            // Hacer las funciones de cambio de pesta√±a disponibles globalmente
            window.cambiarPestana = cambiarPestana;
            
            initMap();
            
            // Configurar botones de capas
            document.getElementById('toggleRios').addEventListener('click', () => toggleLayer('rios'));
            document.getElementById('toggleVias').addEventListener('click', () => toggleLayer('vias'));
            document.getElementById('togglePoblados').addEventListener('click', () => toggleLayer('poblados'));
            document.getElementById('toggleCurvas').addEventListener('click', () => toggleLayer('curvas'));
            document.getElementById('toggleAreas').addEventListener('click', () => toggleLayer('areas'));
            
            // Configurar botones de visibilidad
            document.getElementById('visibilityRios').addEventListener('click', () => toggleLayerVisibility('rios'));
            document.getElementById('visibilityVias').addEventListener('click', () => toggleLayerVisibility('vias'));
            document.getElementById('visibilityPoblados').addEventListener('click', () => toggleLayerVisibility('poblados'));
            document.getElementById('visibilityCurvas').addEventListener('click', () => toggleLayerVisibility('curvas'));
            document.getElementById('visibilityAreas').addEventListener('click', () => toggleLayerVisibility('areas'));
            
            cargarDatos();
            
            // Permitir b√∫squeda con Enter
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') buscarElemento();
            });
        });
    </script>
</body>
</html>
