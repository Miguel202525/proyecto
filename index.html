<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geovisor - Informaci√≥n Geogr√°fica Cant√≥n Azogues</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: #f5f7fa;
        }
        
        .header {
            background: linear-gradient(135deg, #1e5799 0%, #207cca 100%);
            color: white;
            padding: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .layer-toggle {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            padding: 0.5rem;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .layer-toggle button {
            padding: 0.3rem 0.8rem;
            background: rgba(255, 255, 255, 0.3);
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }
        
        .layer-toggle button.active {
            background: white;
            color: #1e5799;
            font-weight: 600;
        }
        
        .controls {
            background: white;
            padding: 1rem;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .search-box {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
            min-width: 250px;
        }
        
        .search-box input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .search-box button {
            padding: 0.5rem 1rem;
            background: #1e5799;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .search-box button:hover {
            background: #18467e;
        }
        
        .info-panel {
            background: #f8f9fa;
            padding: 0.5rem 1rem;
            font-size: 14px;
            color: #666;
            display: flex;
            justify-content: space-between;
        }
        
        .map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.95);
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            text-align: center;
            width: 80%;
            max-width: 400px;
        }
        
        .loading.hidden {
            display: none;
        }
        
        .progress-bar {
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            margin-top: 1rem;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background: #1e5799;
            width: 0%;
            transition: width 0.3s;
        }
        
        /* Custom popup styles */
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .popup-content {
            max-width: 300px;
        }
        
        .popup-content h3 {
            margin: 0 0 0.5rem 0;
            color: #333;
            font-size: 16px;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.3rem;
        }
        
        .popup-content .field {
            margin-bottom: 0.4rem;
            font-size: 14px;
            display: flex;
        }
        
        .popup-content .field strong {
            color: #555;
            min-width: 120px;
        }
        
        .popup-content .field span {
            color: #777;
            flex: 1;
        }
        
        .legend {
            background: white;
            padding: 0.8rem;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            line-height: 1.4;
            max-width: 200px;
        }
        
        .legend-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #1e5799;
            font-size: 14px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.3rem;
        }
        
        .legend-color {
            width: 20px;
            height: 3px;
            margin-right: 0.7rem;
        }
        
        .legend-circle {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.7rem;
        }
        
        .legend-area {
            width: 20px;
            height: 12px;
            margin-right: 0.7rem;
            opacity: 0.5;
        }
        
        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem;
        }
        
        .stats {
            display: flex;
            gap: 0.5rem;
            font-size: 12px;
            flex-wrap: wrap;
        }
        
        .stat-item {
            background: rgba(30, 87, 153, 0.1);
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            white-space: nowrap;
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.8rem;
            }
            
            .layer-toggle {
                width: 100%;
                justify-content: center;
            }
            
            .info-panel {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .stats {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üó∫Ô∏è Geovisor - Informaci√≥n Geogr√°fica Cant√≥n Azogues</h1>
        <div class="layer-toggle">
            <button id="toggleRios" class="active">R√≠os</button>
            <button id="toggleVias">V√≠as</button>
            <button id="togglePoblados">Poblados</button>
            <button id="toggleCurvas">Curvas</button>
            <button id="toggleAreas">√Åreas</button>
        </div>
    </div>
    
    <div class="controls">
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Buscar por nombre..." />
            <button onclick="buscarElemento()">üîç Buscar</button>
            <button onclick="limpiarBusqueda()">‚úñÔ∏è Limpiar</button>
        </div>
    </div>
    
    <div class="info-panel">
        <span id="infoText">Cargando datos geogr√°ficos...</span>
        <div class="stats">
            <div class="stat-item" id="riosStat">R√≠os: 0</div>
            <div class="stat-item" id="viasStat">V√≠as: 0</div>
            <div class="stat-item" id="pobladosStat">Poblados: 0</div>
            <div class="stat-item" id="curvasStat">Curvas: 0</div>
            <div class="stat-item" id="areasStat">√Åreas: 0</div>
        </div>
    </div>
    
    <div class="map-container">
        <div id="loading" class="loading">
            <div>üåç Cargando datos geogr√°ficos...</div>
            <div id="loadingDetail" style="margin-top: 0.5rem; font-size: 14px; color: #666;">
                Iniciando conexi√≥n con Supabase
            </div>
            <div class="progress-bar">
                <div class="progress" id="progressBar"></div>
            </div>
        </div>
        <div id="map"></div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    
    <script>
        // Configuraci√≥n Supabase
        const SUPABASE_URL = 'https://dpgnbjydxxyugorzfodu.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRwZ25ianlkeHh5dWdvcnpmb2R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA0Mzg0NjYsImV4cCI6MjA2NjAxNDQ2Nn0.QB6wkPO_HnCP1AuG3U9XwXHRYk7dOwflfFT_ONdn5Zg';
        
        let map;
        let riosLayer = L.layerGroup();
        let viasLayer = L.layerGroup();
        let pobladosLayer = L.layerGroup();
        let curvasLayer = L.layerGroup();
        let areasLayer = L.layerGroup();
        let allRios = [];
        let allVias = [];
        let allPoblados = [];
        let allCurvas = [];
        let allAreas = [];
        let currentLayer = 'rios';
        let hasDataLoaded = false;
        
        // Inicializar mapa
        function initMap() {
            map = L.map('map').setView([-1.8312, -78.1834], 7);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            riosLayer.addTo(map);
            
            // Leyenda
            const legend = L.control({position: 'bottomright'});
            legend.onAdd = function() {
                const div = L.DomUtil.create('div', 'legend');
                div.innerHTML = `
                    <div class="legend-title">Leyenda</div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color:#1e90ff"></div>
                        <span>R√≠os</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color:#2f4f4f"></div>
                        <span>V√≠as</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-circle" style="background-color:#ff8c00"></div>
                        <span>Poblados</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color:#ff0000"></div>
                        <span>Curvas (Alta)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color:#ff9900"></div>
                        <span>Curvas (Media)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color:#00ff00"></div>
                        <span>Curvas (Baja)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-area" style="background-color:#8a2be2"></div>
                        <span>√Åreas Protegidas</span>
                    </div>
                `;
                return div;
            };
            legend.addTo(map);
        }
        
        // Obtener color seg√∫n la elevaci√≥n para curvas
        function getColorByElevation(elevation) {
            if (elevation > 3000) return '#ff0000';
            if (elevation > 1500) return '#ff9900';
            return '#00ff00';
        }
        
        // Actualizar barra de progreso
        function updateProgress(percent, text) {
            const progressBar = document.getElementById('progressBar');
            const loadingDetail = document.getElementById('loadingDetail');
            
            if (progressBar) progressBar.style.width = percent + '%';
            if (loadingDetail) loadingDetail.textContent = text;
        }
        
        // Cargar datos de Supabase
        async function cargarDatos() {
            const loading = document.getElementById('loading');
            const infoText = document.getElementById('infoText');
            
            try {
                infoText.textContent = 'Conectando con Supabase...';
                updateProgress(10, 'Iniciando conexi√≥n');
                
                // 1. Cargar r√≠os (rio_l)
                updateProgress(15, 'Cargando r√≠os...');
                const riosResponse = await fetch(`${SUPABASE_URL}/rest/v1/rio_l?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!riosResponse.ok) {
                    const errorText = await riosResponse.text();
                    throw new Error(`Error cargando r√≠os: ${riosResponse.status} - ${errorText}`);
                }
                
                allRios = await riosResponse.json();
                procesarRios(allRios);
                document.getElementById('riosStat').textContent = `R√≠os: ${allRios.length}`;
                
                // 2. Cargar v√≠as (via_l)
                updateProgress(25, 'Cargando v√≠as...');
                const viasResponse = await fetch(`${SUPABASE_URL}/rest/v1/via_l?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!viasResponse.ok) {
                    const errorText = await viasResponse.text();
                    throw new Error(`Error cargando v√≠as: ${viasResponse.status} - ${errorText}`);
                }
                
                allVias = await viasResponse.json();
                procesarVias(allVias);
                document.getElementById('viasStat').textContent = `V√≠as: ${allVias.length}`;
                
                // 3. Cargar poblados (poblado_p)
                updateProgress(35, 'Cargando poblados...');
                const pobladosResponse = await fetch(`${SUPABASE_URL}/rest/v1/poblado_p?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!pobladosResponse.ok) {
                    const errorText = await pobladosResponse.text();
                    throw new Error(`Error cargando poblados: ${pobladosResponse.status} - ${errorText}`);
                }
                
                allPoblados = await pobladosResponse.json();
                procesarPoblados(allPoblados);
                document.getElementById('pobladosStat').textContent = `Poblados: ${allPoblados.length}`;
                
                // 4. Cargar curvas de nivel (curva_nivel_l)
                updateProgress(55, 'Cargando curvas de nivel...');
                const curvasResponse = await fetch(`${SUPABASE_URL}/rest/v1/curva_nivel_l?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!curvasResponse.ok) {
                    const errorText = await curvasResponse.text();
                    throw new Error(`Error cargando curvas: ${curvasResponse.status} - ${errorText}`);
                }
                
                allCurvas = await curvasResponse.json();
                procesarCurvas(allCurvas);
                document.getElementById('curvasStat').textContent = `Curvas: ${allCurvas.length}`;
                
                // 5. Cargar √°reas protegidas (nombres_areas_p)
                updateProgress(75, 'Cargando √°reas protegidas...');
                const areasResponse = await fetch(`${SUPABASE_URL}/rest/v1/nombres_areas_p?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!areasResponse.ok) {
                    const errorText = await areasResponse.text();
                    throw new Error(`Error cargando √°reas: ${areasResponse.status} - ${errorText}`);
                }
                
                allAreas = await areasResponse.json();
                procesarAreas(allAreas);
                document.getElementById('areasStat').textContent = `√Åreas: ${allAreas.length}`;
                
                // Finalizar carga
                updateProgress(100, 'Carga completada');
                setTimeout(() => {
                    loading.classList.add('hidden');
                    hasDataLoaded = true;
                    infoText.textContent = `‚úÖ Datos cargados correctamente`;
                }, 500);
                
            } catch (error) {
                console.error('Error cargando datos:', error);
                loading.classList.add('hidden');
                infoText.textContent = `‚ùå Error: ${error.message}`;
                
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.innerHTML = `
                    <strong>Error al cargar los datos:</strong> ${error.message}<br>
                    Verifique: 
                    <ul>
                        <li>La conexi√≥n a internet</li>
                        <li>La configuraci√≥n de Supabase</li>
                        <li>Los permisos de las tablas</li>
                    </ul>
                `;
                document.querySelector('.map-container').appendChild(errorDiv);
            }
        }
        
        // Procesar r√≠os
        function procesarRios(rios) {
            riosLayer.clearLayers();
            
            if (!rios || rios.length === 0) {
                console.warn('No hay datos de r√≠os para procesar');
                return;
            }
            
            const features = [];
            
            for (const rio of rios) {
                try {
                    if (!rio.geom) continue;
                    
                    // Manejar geometr√≠a
                    let geometry = rio.geom;
                    if (typeof geometry === 'string') {
                        try {
                            geometry = JSON.parse(geometry);
                        } catch (e) {
                            console.warn('Error parseando geometr√≠a de r√≠o:', rio);
                            continue;
                        }
                    }
                    
                    // Crear feature
                    const feature = {
                        type: 'Feature',
                        properties: rio,
                        geometry: geometry
                    };
                    
                    features.push(feature);
                    
                } catch (error) {
                    console.warn('Error procesando r√≠o:', rio, error);
                }
            }
            
            // Crear capa GeoJSON
            if (features.length > 0) {
                const geoJsonLayer = L.geoJSON(features, {
                    style: {
                        color: '#1e90ff',
                        weight: 2,
                        opacity: 0.8
                    },
                    onEachFeature: function(feature, layer) {
                        const popupContent = crearPopupRio(feature.properties);
                        layer.bindPopup(popupContent);
                    }
                });
                
                geoJsonLayer.addTo(riosLayer);
            }
        }
        
        // Procesar v√≠as
        function procesarVias(vias) {
            viasLayer.clearLayers();
            
            if (!vias || vias.length === 0) {
                console.warn('No hay datos de v√≠as para procesar');
                return;
            }
            
            const features = [];
            
            for (const via of vias) {
                try {
                    if (!via.geom) continue;
                    
                    // Manejar geometr√≠a
                    let geometry = via.geom;
                    if (typeof geometry === 'string') {
                        try {
                            geometry = JSON.parse(geometry);
                        } catch (e) {
                            console.warn('Error parseando geometr√≠a de v√≠a:', via);
                            continue;
                        }
                    }
                    
                    // Crear feature
                    const feature = {
                        type: 'Feature',
                        properties: via,
                        geometry: geometry
                    };
                    
                    features.push(feature);
                    
                } catch (error) {
                    console.warn('Error procesando v√≠a:', via, error);
                }
            }
            
            // Crear capa GeoJSON
            if (features.length > 0) {
                const geoJsonLayer = L.geoJSON(features, {
                    style: {
                        color: '#2f4f4f',
                        weight: 3,
                        opacity: 0.8
                    },
                    onEachFeature: function(feature, layer) {
                        const popupContent = crearPopupVia(feature.properties);
                        layer.bindPopup(popupContent);
                    }
                });
                
                geoJsonLayer.addTo(viasLayer);
            }
        }
        
        // Procesar poblados
        function procesarPoblados(poblados) {
            pobladosLayer.clearLayers();
            
            if (!poblados || poblados.length === 0) {
                console.warn('No hay datos de poblados para procesar');
                return;
            }
            
            const features = [];
            
            for (const poblado of poblados) {
                try {
                    if (!poblado.geom) continue;
                    
                    // Manejar geometr√≠a
                    let geometry = poblado.geom;
                    if (typeof geometry === 'string') {
                        try {
                            geometry = JSON.parse(geometry);
                        } catch (e) {
                            console.warn('Error parseando geometr√≠a de poblado:', poblado);
                            continue;
                        }
                    }
                    
                    // Crear feature
                    const feature = {
                        type: 'Feature',
                        properties: poblado,
                        geometry: geometry
                    };
                    
                    features.push(feature);
                    
                } catch (error) {
                    console.warn('Error procesando poblado:', poblado, error);
                }
            }
            
            // Crear capa GeoJSON
            if (features.length > 0) {
                const geoJsonLayer = L.geoJSON(features, {
                    pointToLayer: function(feature, latlng) {
                        return L.circleMarker(latlng, {
                            radius: 6,
                            fillColor: '#ff8c00',
                            color: '#cc7000',
                            weight: 1,
                            opacity: 1,
                            fillOpacity: 0.8
                        });
                    },
                    onEachFeature: function(feature, layer) {
                        const popupContent = crearPopupPoblado(feature.properties);
                        layer.bindPopup(popupContent);
                    }
                });
                
                geoJsonLayer.addTo(pobladosLayer);
            }
        }
        
        // Procesar curvas de nivel
        function procesarCurvas(curvas) {
            curvasLayer.clearLayers();
            
            if (!curvas || curvas.length === 0) {
                console.warn('No hay datos de curvas para procesar');
                return;
            }
            
            const features = [];
            
            for (const curva of curvas) {
                try {
                    if (!curva.geom) continue;
                    
                    // Manejar geometr√≠a
                    let geometry = curva.geom;
                    if (typeof geometry === 'string') {
                        try {
                            geometry = JSON.parse(geometry);
                        } catch (e) {
                            console.warn('Error parseando geometr√≠a de curva:', curva);
                            continue;
                        }
                    }
                    
                    // Extraer elevaci√≥n (suponiendo que est√° en el campo "crv")
                    const elevation = curva.crv || 0;
                    
                    // Crear feature
                    const feature = {
                        type: 'Feature',
                        properties: {
                            ...curva,
                            elevation: elevation
                        },
                        geometry: geometry
                    };
                    
                    features.push(feature);
                    
                } catch (error) {
                    console.warn('Error procesando curva:', curva, error);
                }
            }
            
            // Crear capa GeoJSON
            if (features.length > 0) {
                const geoJsonLayer = L.geoJSON(features, {
                    style: function(feature) {
                        return {
                            color: getColorByElevation(feature.properties.elevation || 0),
                            weight: 1,
                            opacity: 0.7
                        };
                    },
                    onEachFeature: function(feature, layer) {
                        const popupContent = crearPopupCurva(feature.properties);
                        layer.bindPopup(popupContent);
                    }
                });
                
                geoJsonLayer.addTo(curvasLayer);
            }
        }
        
        // Procesar √°reas protegidas
        function procesarAreas(areas) {
            areasLayer.clearLayers();
            
            if (!areas || areas.length === 0) {
                console.warn('No hay datos de √°reas para procesar');
                return;
            }
            
            const features = [];
            
            for (const area of areas) {
                try {
                    if (!area.geom) continue;
                    
                    // Manejar geometr√≠a
                    let geometry = area.geom;
                    if (typeof geometry === 'string') {
                        try {
                            geometry = JSON.parse(geometry);
                        } catch (e) {
                            console.warn('Error parseando geometr√≠a de √°rea:', area);
                            continue;
                        }
                    }
                    
                    // Crear feature
                    const feature = {
                        type: 'Feature',
                        properties: area,
                        geometry: geometry
                    };
                    
                    features.push(feature);
                    
                } catch (error) {
                    console.warn('Error procesando √°rea:', area, error);
                }
            }
            
            // Crear capa GeoJSON
            if (features.length > 0) {
                const geoJsonLayer = L.geoJSON(features, {
                    style: {
                        color: '#8a2be2',
                        weight: 2,
                        opacity: 0.8,
                        fillColor: '#8a2be2',
                        fillOpacity: 0.3
                    },
                    onEachFeature: function(feature, layer) {
                        const popupContent = crearPopupArea(feature.properties);
                        layer.bindPopup(popupContent);
                    }
                });
                
                geoJsonLayer.addTo(areasLayer);
            }
        }
        
        // Crear popup para r√≠os
        function crearPopupRio(rio) {
            return `
                <div class="popup-content">
                    <h3>${rio.nam || 'R√≠o'}</h3>
                    ${rio.fcode ? `<div class="field"><strong>C√≥digo:</strong> <span>${rio.fcode}</span></div>` : ''}
                    ${rio.descripcio ? `<div class="field"><strong>Descripci√≥n:</strong> <span>${rio.descripcio}</span></div>` : ''}
                    ${rio.naz ? `<div class="field"><strong>Naz:</strong> <span>${rio.naz}</span></div>` : ''}
                    ${rio.sec ? `<div class="field"><strong>Sec:</strong> <span>${rio.sec}</span></div>` : ''}
                    ${rio.sec_desc ? `<div class="field"><strong>Sec Desc:</strong> <span>${rio.sec_desc}</span></div>` : ''}
                    ${rio.hyp ? `<div class="field"><strong>Hyp:</strong> <span>${rio.hyp}</span></div>` : ''}
                    ${rio.hyp_desc ? `<div class="field"><strong>Hyp Desc:</strong> <span>${rio.hyp_desc}</span></div>` : ''}
                    ${rio.txt ? `<div class="field"><strong>Info:</strong> <span>${rio.txt}</span></div>` : ''}
                    ${rio.Shape_Leng ? `<div class="field"><strong>Longitud:</strong> <span>${rio.Shape_Leng.toFixed(2)} m</span></div>` : ''}
                </div>
            `;
        }
        
        // Crear popup para v√≠as
        function crearPopupVia(via) {
            return `
                <div class="popup-content">
                    <h3>${via.nam || 'V√≠a'}</h3>
                    ${via.descriptio ? `<div class="field"><strong>Descripci√≥n:</strong> <span>${via.descriptio}</span></div>` : ''}
                    ${via.acc ? `<div class="field"><strong>Acc:</strong> <span>${via.acc}</span></div>` : ''}
                    ${via.acc_desc ? `<div class="field"><strong>Acc Desc:</strong> <span>${via.acc_desc}</span></div>` : ''}
                    ${via.rst ? `<div class="field"><strong>Rst:</strong> <span>${via.rst}</span></div>` : ''}
                    ${via.rst_desc ? `<div class="field"><strong>Rst Desc:</strong> <span>${via.rst_desc}</span></div>` : ''}
                    ${via.typ ? `<div class="field"><strong>Typ:</strong> <span>${via.typ}</span></div>` : ''}
                    ${via.typ_desc ? `<div class="field"><strong>Typ Desc:</strong> <span>${via.typ_desc}</span></div>` : ''}
                    ${via.loc ? `<div class="field"><strong>Loc:</strong> <span>${via.loc}</span></div>` : ''}
                    ${via.loc_desc ? `<div class="field"><strong>Loc Desc:</strong> <span>${via.loc_desc}</span></div>` : ''}
                    ${via.txt ? `<div class="field"><strong>Info:</strong> <span>${via.txt}</span></div>` : ''}
                </div>
            `;
        }
        
        // Crear popup para poblados
        function crearPopupPoblado(poblado) {
            return `
                <div class="popup-content">
                    <h3>${poblado.nam || 'Poblado'}</h3>
                    ${poblado.fcode ? `<div class="field"><strong>C√≥digo:</strong> <span>${poblado.fcode}</span></div>` : ''}
                    ${poblado.descriptio ? `<div class="field"><strong>Descripci√≥n:</strong> <span>${poblado.descriptio}</span></div>` : ''}
                    ${poblado.naz ? `<div class="field"><strong>Naz:</strong> <span>${poblado.naz}</span></div>` : ''}
                    ${poblado.ppt ? `<div class="field"><strong>Ppt:</strong> <span>${poblado.ppt}</span></div>` : ''}
                    ${poblado.ppt_desc ? `<div class="field"><strong>Ppt Desc:</strong> <span>${poblado.ppt_desc}</span></div>` : ''}
                    ${poblado.nuts ? `<div class="field"><strong>Nuts:</strong> <span>${poblado.nuts}</span></div>` : ''}
                    ${poblado.txt ? `<div class="field"><strong>Info:</strong> <span>${poblado.txt}</span></div>` : ''}
                </div>
            `;
        }
        
        // Crear popup para curvas de nivel
        function crearPopupCurva(curva) {
            return `
                <div class="popup-content">
                    <h3>${curva.foods || 'Curva de Nivel'}</h3>
                    ${curva.id ? `<div class="field"><strong>ID:</strong> <span>${curva.id}</span></div>` : ''}
                    ${curva.descriptio ? `<div class="field"><strong>Descripci√≥n:</strong> <span>${curva.descriptio}</span></div>` : ''}
                    ${curva.acc ? `<div class="field"><strong>Acc:</strong> <span>${curva.acc}</span></div>` : ''}
                    ${curva.acc_desc ? `<div class="field"><strong>Acc Desc:</strong> <span>${curva.acc_desc}</span></div>` : ''}
                    ${curva.hqc ? `<div class="field"><strong>HQC:</strong> <span>${curva.hqc}</span></div>` : ''}
                    ${curva.hqc_desc ? `<div class="field"><strong>HQC Desc:</strong> <span>${curva.hqc_desc}</span></div>` : ''}
                    ${curva.ela ? `<div class="field"><strong>ELA:</strong> <span>${curva.ela}</span></div>` : ''}
                    ${curva.ela_desc ? `<div class="field"><strong>ELA Desc:</strong> <span>${curva.ela_desc}</span></div>` : ''}
                    ${curva.crv ? `<div class="field"><strong>Elevaci√≥n:</strong> <span>${curva.crv} m</span></div>` : ''}
                    ${curva.txt ? `<div class="field"><strong>Info:</strong> <span>${curva.txt}</span></div>` : ''}
                    ${curva.SHAPE_Leng ? `<div class="field"><strong>Longitud:</strong> <span>${curva.SHAPE_Leng.toFixed(2)} m</span></div>` : ''}
                </div>
            `;
        }
        
        // Crear popup para √°reas protegidas
        function crearPopupArea(area) {
            return `
                <div class="popup-content">
                    <h3>${area.nam || '√Årea Protegida'}</h3>
                    ${area.id ? `<div class="field"><strong>ID:</strong> <span>${area.id}</span></div>` : ''}
                    ${area.icode ? `<div class="field"><strong>C√≥digo:</strong> <span>${area.icode}</span></div>` : ''}
                    ${area.descriptio ? `<div class="field"><strong>Descripci√≥n:</strong> <span>${area.descriptio}</span></div>` : ''}
                    ${area.txt ? `<div class="field"><strong>Info:</strong> <span>${area.txt}</span></div>` : ''}
                </div>
            `;
        }
        
        // Alternar entre capas
        function toggleLayer(layer) {
            currentLayer = layer;
            
            // Ocultar todas las capas primero
            riosLayer.remove();
            viasLayer.remove();
            pobladosLayer.remove();
            curvasLayer.remove();
            areasLayer.remove();
            
            // Quitar clase activa de todos los botones
            document.querySelectorAll('.layer-toggle button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Activar la capa seleccionada
            if (layer === 'rios') {
                riosLayer.addTo(map);
                document.getElementById('toggleRios').classList.add('active');
                document.getElementById('infoText').textContent = `‚úÖ Capa de r√≠os activa`;
                
                // Ajustar vista si hay datos
                if (riosLayer.getLayers().length > 0) {
                    const group = new L.featureGroup(riosLayer.getLayers());
                    map.fitBounds(group.getBounds(), { padding: [20, 20] });
                }
            } 
            else if (layer === 'vias') {
                viasLayer.addTo(map);
                document.getElementById('toggleVias').classList.add('active');
                document.getElementById('infoText').textContent = `‚úÖ Capa de v√≠as activa`;
                
                // Ajustar vista si hay datos
                if (viasLayer.getLayers().length > 0) {
                    const group = new L.featureGroup(viasLayer.getLayers());
                    map.fitBounds(group.getBounds(), { padding: [20, 20] });
                }
            } 
            else if (layer === 'poblados') {
                pobladosLayer.addTo(map);
                document.getElementById('togglePoblados').classList.add('active');
                document.getElementById('infoText').textContent = `‚úÖ Capa de poblados activa`;
                
                // Ajustar vista si hay datos
                if (pobladosLayer.getLayers().length > 0) {
                    const group = new L.featureGroup(pobladosLayer.getLayers());
                    map.fitBounds(group.getBounds(), { padding: [20, 20] });
                }
            }
            else if (layer === 'curvas') {
                curvasLayer.addTo(map);
                document.getElementById('toggleCurvas').classList.add('active');
                document.getElementById('infoText').textContent = `‚úÖ Capa de curvas activa`;
                
                // Ajustar vista si hay datos
                if (curvasLayer.getLayers().length > 0) {
                    const group = new L.featureGroup(curvasLayer.getLayers());
                    map.fitBounds(group.getBounds(), { padding: [20, 20] });
                }
            }
            else if (layer === 'areas') {
                areasLayer.addTo(map);
                document.getElementById('toggleAreas').classList.add('active');
                document.getElementById('infoText').textContent = `‚úÖ Capa de √°reas activa`;
                
                // Ajustar vista si hay datos
                if (areasLayer.getLayers().length > 0) {
                    const group = new L.featureGroup(areasLayer.getLayers());
                    map.fitBounds(group.getBounds(), { padding: [20, 20] });
                }
            }
        }
        
        // Funci√≥n de b√∫squeda
        function buscarElemento() {
            if (!hasDataLoaded) {
                alert('Los datos a√∫n se est√°n cargando. Por favor espere.');
                return;
            }
            
            const searchTerm = document.getElementById('searchInput').value.trim();
            if (!searchTerm) return;
            
            let elementosEncontrados = [];
            let tipoElemento = '';
            
            if (currentLayer === 'rios') {
                elementosEncontrados = allRios.filter(rio => {
                    const campos = [
                        rio.nam,
                        rio.descripcio,
                        rio.naz,
                        rio.txt
                    ].filter(Boolean).map(c => c.toString().toLowerCase());
                    
                    return campos.some(campo => campo.includes(searchTerm.toLowerCase()));
                });
                tipoElemento = 'r√≠os';
                
                // Procesar resultados
                if (elementosEncontrados.length > 0) {
                    procesarRios(elementosEncontrados);
                    
                    // Ajustar vista a los resultados
                    if (riosLayer.getLayers().length > 0) {
                        const group = new L.featureGroup(riosLayer.getLayers());
                        map.fitBounds(group.getBounds(), { padding: [20, 20] });
                    }
                }
            } 
            else if (currentLayer === 'vias') {
                elementosEncontrados = allVias.filter(via => {
                    const campos = [
                        via.nam,
                        via.descriptio,
                        via.acc_desc,
                        via.rst_desc,
                        via.txt
                    ].filter(Boolean).map(c => c.toString().toLowerCase());
                    
                    return campos.some(campo => campo.includes(searchTerm.toLowerCase()));
                });
                tipoElemento = 'v√≠as';
                
                // Procesar resultados
                if (elementosEncontrados.length > 0) {
                    procesarVias(elementosEncontrados);
                    
                    // Ajustar vista a los resultados
                    if (viasLayer.getLayers().length > 0) {
                        const group = new L.featureGroup(viasLayer.getLayers());
                        map.fitBounds(group.getBounds(), { padding: [20, 20] });
                    }
                }
            } 
            else if (currentLayer === 'poblados') {
                elementosEncontrados = allPoblados.filter(poblado => {
                    const campos = [
                        poblado.nam,
                        poblado.descriptio,
                        poblado.naz,
                        poblado.txt
                    ].filter(Boolean).map(c => c.toString().toLowerCase());
                    
                    return campos.some(campo => campo.includes(searchTerm.toLowerCase()));
                });
                tipoElemento = 'poblados';
                
                // Procesar resultados
                if (elementosEncontrados.length > 0) {
                    procesarPoblados(elementosEncontrados);
                    
                    // Ajustar vista a los resultados
                    if (pobladosLayer.getLayers().length > 0) {
                        const group = new L.featureGroup(pobladosLayer.getLayers());
                        map.fitBounds(group.getBounds(), { padding: [20, 20] });
                    }
                }
            }
            else if (currentLayer === 'curvas') {
                elementosEncontrados = allCurvas.filter(curva => {
                    const campos = [
                        curva.foods,
                        curva.descriptio,
                        curva.acc_desc,
                        curva.txt
                    ].filter(Boolean).map(c => c.toString().toLowerCase());
                    
                    return campos.some(campo => campo.includes(searchTerm.toLowerCase()));
                });
                tipoElemento = 'curvas de nivel';
                
                // Procesar resultados
                if (elementosEncontrados.length > 0) {
                    procesarCurvas(elementosEncontrados);
                    
                    // Ajustar vista a los resultados
                    if (curvasLayer.getLayers().length > 0) {
                        const group = new L.featureGroup(curvasLayer.getLayers());
                        map.fitBounds(group.getBounds(), { padding: [20, 20] });
                    }
                }
            }
            else if (currentLayer === 'areas') {
                elementosEncontrados = allAreas.filter(area => {
                    const campos = [
                        area.nam,
                        area.descriptio,
                        area.icode,
                        area.txt
                    ].filter(Boolean).map(c => c.toString().toLowerCase());
                    
                    return campos.some(campo => campo.includes(searchTerm.toLowerCase()));
                });
                tipoElemento = '√°reas protegidas';
                
                // Procesar resultados
                if (elementosEncontrados.length > 0) {
                    procesarAreas(elementosEncontrados);
                    
                    // Ajustar vista a los resultados
                    if (areasLayer.getLayers().length > 0) {
                        const group = new L.featureGroup(areasLayer.getLayers());
                        map.fitBounds(group.getBounds(), { padding: [20, 20] });
                    }
                }
            }
            
            if (elementosEncontrados.length === 0) {
                document.getElementById('infoText').textContent = `‚ùå No se encontraron ${tipoElemento} con "${searchTerm}"`;
            } else {
                document.getElementById('infoText').textContent = `üîç ${elementosEncontrados.length} ${tipoElemento} encontrados para "${searchTerm}"`;
            }
        }
        
        // Limpiar b√∫squeda
        function limpiarBusqueda() {
            document.getElementById('searchInput').value = '';
            
            if (currentLayer === 'rios') {
                procesarRios(allRios);
                document.getElementById('infoText').textContent = `‚úÖ Capa de r√≠os activa`;
            } 
            else if (currentLayer === 'vias') {
                procesarVias(allVias);
                document.getElementById('infoText').textContent = `‚úÖ Capa de v√≠as activa`;
            } 
            else if (currentLayer === 'poblados') {
                procesarPoblados(allPoblados);
                document.getElementById('infoText').textContent = `‚úÖ Capa de poblados activa`;
            }
            else if (currentLayer === 'curvas') {
                procesarCurvas(allCurvas);
                document.getElementById('infoText').textContent = `‚úÖ Capa de curvas activa`;
            }
            else if (currentLayer === 'areas') {
                procesarAreas(allAreas);
                document.getElementById('infoText').textContent = `‚úÖ Capa de √°reas activa`;
            }
        }
        
        // Inicializar cuando se carga la p√°gina
        window.addEventListener('DOMContentLoaded', function() {
            initMap();
            
            // Configurar botones de capas
            document.getElementById('toggleRios').addEventListener('click', () => toggleLayer('rios'));
            document.getElementById('toggleVias').addEventListener('click', () => toggleLayer('vias'));
            document.getElementById('togglePoblados').addEventListener('click', () => toggleLayer('poblados'));
            document.getElementById('toggleCurvas').addEventListener('click', () => toggleLayer('curvas'));
            document.getElementById('toggleAreas').addEventListener('click', () => toggleLayer('areas'));
            
            cargarDatos();
            
            // Permitir b√∫squeda con Enter
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') buscarElemento();
            });
        });
    </script>
</body>
</html>
